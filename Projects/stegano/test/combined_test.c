#include <limits.h>
#include <stdlib.h>
#include <time.h>

#include "unity.h"
#include "resource_detector.h"

#include "stegano.h"
#include "bit.h"
#include "bmp.h"

void setUp(void)
{

}

void tearDown(void)
{

}

#ifdef TESTING
static void multiplexTest(void)
{
	multiplex("1.bmp", "2.bmp");
}

static void demultiplexTest(void)
{
	demultiplex("mux_1.bmp_2.bmp_1.bmp", "out1.bmp", "out2.bmp");
}

static void multiplexTextTest(void)
{
	multiplexText("1.bmp", "txt.txt");
}

static void demultiplexTextTest(void)
{
	demultiplexText("mux_1.bmp_txt.txt.bmp", "untext.bmp", "untext.txt");
}

static void bitTest(void)
{
	const uint8_t TestData[] = { 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x01, 0x02, 0x04, 0x08, 0x10, 0x20, 0x40, 0x80,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x02, 0x04, 0x08,
		0x10, 0x20, 0x40, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x01, 0x02, 0x04, 0x08, 0x10, 0x20, 0x40, 0x80, 0x01, 0x02, 0x04, 0x08,
		0x10, 0x20, 0x40, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x02,
		0x04, 0x08, 0x10, 0x20, 0x40, 0x80, 0x01, 0x02, 0x04, 0x08, 0x10, 0x20,
		0x40, 0x02, 0x04, 0x08, 0x10, 0x20, 0x40, 0x80, 0x01, 0x02, 0x04, 0x08,
		0x10, 0x20, 0x40, 0x02, 0x04, 0x08, 0x10, 0x20, 0x40, 0x80, 0x03, 0x06,
		0x0c, 0x18, 0x30, 0x60, 0xc0, 0x04, 0x08, 0x10, 0x20, 0x40, 0x80, 0x02,
		0x04, 0x08, 0x10, 0x20, 0x40, 0x05, 0x0a, 0x14, 0x28, 0x50, 0xa0, 0x02,
		0x04, 0x08, 0x10, 0x20, 0x40, 0x05, 0x0a, 0x14, 0x28, 0x50, 0xa0, 0x06,
		0x0c, 0x18, 0x30, 0x60, 0xc0, 0x04, 0x08, 0x10, 0x20, 0x40, 0x0a, 0x14,
		0x28, 0x50, 0xa0, 0x05, 0x0a, 0x14, 0x28, 0x50, 0x0a, 0x14, 0x28, 0x50,
		0xa0, 0x0d, 0x1a, 0x34, 0x68, 0xd0, 0x14, 0x28, 0x50, 0xa0, 0x0a, 0x14,
		0x28, 0x50, 0x15, 0x2a, 0x54, 0xa8, 0x1a, 0x34, 0x68, 0xd0, 0x14, 0x28,
		0x50, 0x2a, 0x54, 0xa8, 0x35, 0x6a, 0xd4, 0x54, 0xa8, 0x6a, 0xd4 };
	uint8_t Src = 0xd4;
	uint8_t SrcPos;
	uint8_t NrBits;
	uint8_t DestPos;
	int TestDataIndex = 0;

	for (int j = 1; j < 8; j++)
	{
		for (int i = 0; i < 8; i++)
		{
			for (int k = 0; k < 8; k++)
			{
				if ((i + j <= 8) && (k + j <= 8))
				{
					SrcPos = i;
					NrBits = j;
					DestPos = k;
					TEST_ASSERT_EQUAL_HEX8(TestData[TestDataIndex++], getSubstring(Src, SrcPos, NrBits, DestPos));
				}
			}
		}
	}

}

int main(int argc, char * argv[])
{
	UnityBegin();

	RUN_TEST(multiplexTest, __LINE__);
	RUN_TEST(demultiplexTest, __LINE__);
	RUN_TEST(multiplexTextTest, __LINE__);
	RUN_TEST(demultiplexTextTest, __LINE__);

	RUN_TEST(bitTest, __LINE__);

	return UnityEnd();
}
#endif